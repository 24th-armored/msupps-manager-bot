# 24th Msupps Manager Bot - Specification

The bot will track 1-2 sets of 5-20 supply sources managed by a regiment in the game Foxhole. Each set of supply sources is managed by separate people in a Discord channel dedicated to that set. The bot can be in several servers, and will keep separate data for each server. Each server can have several sets.
A set has a name. There are commands to create, update, and delete the set for the current channel.
A supply source (within a set) is identified by a number unique within the set (usually counting from 1 with no gaps, but not always). A supply source has a stockpile of maintenance supplies ("msupps") between 0 and 32000. A supply source has an hourly consumption rate of msupps anywhere between 1 and several hundred. Because the consumption rate can fluctuate, the stockpiles known to the bot will be an estimate. Users can update a supply source to correct the consumption rate, or the stockpile, or change its number. There are commands to create and delete a source.
The state of a supply source's stockpile should be handled in this way:
- Rather than "ticking down" every hour, store a checkpoint value for the stockpile with a timestamp. Then keep a total of all delivery amounts since the checkpoint (including deliveries at the same exact time as the checkpoint).
- Whenever we need to know the current stockpile, compute the interval since the checkpoint, compute the consumption over that interval, and subtract it from the total deliveries. Round down to a whole number.
- If the consumption rate is ever updated, compute the current stockpile (using the old consumption rate) and make that the new stockpile checkpoint.
- If the stockpile is ever updated directly, make that the new stockpile checkpoint.
- If the current stockpile is ever computed as 0, make that the new stockpile checkpoint at that time.
- If a delivery is made to a stockpile at 0, update the checkpoint time to the delivery time (but leave the checkpoint amount at 0).
- Besides the checkpoint, track a timestamp for the last time the stockpile's quantity was manually set. This is not updated when a consumption rate change triggers the checkpoint to update.
Msupps must be delivered to them regularly to prevent their stockpiles from emptying. Players who deliver msupps to a supply source will use a command in the correct channel to tell the bot how many msupps were delivered, and to which location. When msupps are delivered, the usual scenario is that the user who sends the command is the player who made the delivery, the current time is the delivery time, and the msupp amount is 30 times the hourly rate for that supply source. Those values should be the defaults, but the user should be able to override them. It's impossible to increase the stockpile beyond 32k, so if a user enters a delivery that would do this, record the delivery as the clamped amount, and inform the user about this.
When the user issues the command to enter a delivery to a supply source, it should display the consumption rate (1h and 30h), current stockpile (quantity and number of hours), and the details of the most recent delivery (showing the relative time since it). The user can click a button to record a 30hr amount delivery in one click, or click another button to fill out different details of the delivery manually.
Besides changing the state of the supply source, the bot should remember these deliveries so that they can be queried later.
The bot will listen for commands in these channels, and maintain a message always at the bottom of each channel summarizing the current state of that set of supply sources. This sticky summary message should behave in this way:
- It will have an image that displays a map of the supply sources for reference by users. This image is set and updated by a special command.
- If any supply sources have less than 6 hours remaining, list them in order by their number, with marking/formatting indicating extreme urgency.
- If any have less than 12 hours remaining, list them and indicate urgency.
- If any have less than 24 hours remaining, or did not receive a delivery either today or yesterday, list them and indicate priority.
- If any have not received a delivery yet either today or in the last 6 hours, list them. They are "red" (as are all the previous categories).
- If any have received one or more deliveries either today or in the last 6 hours, but the total amount of these deliveries is less than the 30-hour amount, they are "yellow". They should be listed together with the previous category, in order by their number.
- The remaining supply sources, which have recent deliveries amounting to the 30-hour consumption, are "green" and should not be listed; just display at the bottom how many of them there are.
- There are two exceptions. First, if a supply source is close enough to full that a delivery of the 30-hour amount is not possible because it would put the stockpile over 32k, this supply source is "green" even if it has received no recent delivery.
- Second, if a supply source has over 30 days worth of stockpile, it is "green" even if it has received no recent delivery.
- The summary message will be updated every 15 minutes, at :00, :15, :30, and :45 each hour.
- The summary message will also be updated any time the bot receives a command that changes its state for that set (including deleting deliveries).
"Today" and "yesterday" are defined with reference to 8:00 AM UTC. So, if the current time is 9:30 AM UTC, the window for "recent deliveries" goes back to 3:30 AM. If the current time is 1:00 AM, the window goes back to 8:00 AM (17 hours earlier). All dates & times should be stored in UTC.
There should be a button under the summary message to display basic info for all supply sources (in this set) in order. Each should show the current consumption rates for 1h and for 30h, and the number of hours in the current estimated stockpile. This display should only be visible to the user that issued the command, and it should dismiss itself after 5 minutes.
There is a command to check the status of a supply source. It shows the current (estimated) stockpile both as a quantity and as a number of hours, the relative time since the stockpile was manually set (not via delivery), current consumption rate (for 1h, 24h, and 30h), and the relative time since that rate was updated. It also shows the last 10 deliveries, and allows the user to delete any of them. Deliveries are deleted when they were entered into the bot incorrectly and never actually happened. So, when deleting a delivery that was before the last checkpoint, leave the stockpile as-is, but if the deleted delivery was after the last checkpoint, the total delivery quantity should decrease, and if this would cause the current stockpile to be 0, then the checkpoint should be updated accordingly.
Data should be stored in a free cloud database. Sets, supply sources, and deliveries have persistent internal IDs that aren't displayed. Deleting sets, supply sources, or deliveries will not truly remove their data from the database, only archive it or mark it to be filtered out from all business logic queries.
Race conditions should be avoided for concurrent operations. Everyone (with write access to the set channel) can run any command.
For every operation that changes state: the bot posts a message visible to all acknowledging/logging the operation in the set's channel, including who initiated it, and updates the summary message. Besides these and the summary message, all other messages sent by the bot (like displays of data where there is no state change) are visible only to the user who prompted them.
The code will be implemented with TypeScript, managed on GitHub and deployed on a cloud service with CI/CD. Secrets (Discord bot token, DB connection, etc) should be managed appropriately.
